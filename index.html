<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>COIN GAME</title>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <style>
    canvas{
        background-color:#eee;
    }
    body{
        max-width:900px;
        margin:0 auto;
        text-align:center;
    }
    </style>
</head>
<body>
<div class="content">
    <canvas id="canvas" width="500" height="300"></canvas>
    <div id="upButton" class="button">
        <div>
            <span class="up"></span>
        </div>
    </div>
</div>

<script>
    var cvs = document.getElementById("canvas");
    var ctx = cvs.getContext("2d");

    var bg = new Image(); //背景
    var bird = new Image(); //鳥
    var fg = new Image(); //地面
    var pipeSouth = new Image(); //ドカン下
    var pipeSouth2 = new Image();
    
    bg.src = "fig/2021-08-20-19-25-26.png";
    bird.src = "fig/2021-08-20-19-09-12.png";
    fg.src = "fig/2021-08-20-13-16-24.png";
    pipeSouth.src = "fig/2021-08-20-13-14-31.png";
    pipeSouth2.src = "fig/2021-08-20-13-13-27.png";


    var bX = 50;  //鳥の表示位置250
    var bY = cvs.height - (fg.height + bird.height)-1;  //鳥の表示位置205
    var score = 0;



    var pipe = [];
    pipe[0] = {
        x : cvs.width, //canvas幅
        y : 0
    };

    var coin = [];
    coin[0] = {
        x : cvs.width, //canvas幅
        y : 0,
    };
    
    var ground = [];
    ground[0] = {
        x : 0, //canvas幅
        y : 0
    };

    // キーボード操作
    var spacePressed = false;

document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);

function keyDownHandler(e) {
    if(e.keyCode == "32") {
        spacePressed = true;
    }
}

function keyUpHandler(e) {
    if(e.keyCode == "32") {
        spacePressed = false;
    }
}
    function reload() {
        location.reload();
    }


    function draw(){
        ctx.drawImage(bg,0,0);
        ctx.drawImage(bird,bX,bY);
         

        for(var n=0 ; n < pipe.length; n++){
           
            ctx.drawImage(pipeSouth,pipe[n].x,cvs.height - fg.height);
            ctx.drawImage(pipeSouth2,pipe[n].x+450,cvs.height-fg.height);
            var scroll = pipe[n].x--;
            
            if( pipe[n].x == 0 ){  
                pipe.push({
                    x : cvs.width,
                    y : cvs.height - fg.height
                });
            }
            
           

        for(var l=0 ; l < coin.length; l++){

            ctx.beginPath();
            ctx.arc(coin[l].x, coin[l].y+200, 10, 0, Math.PI*2, false);
            ctx.fillStyle = "gold";
            ctx.fill();
            ctx.closePath();

            ctx.beginPath();
            ctx.arc(coin[l].x, coin[l].y+200, 8, 0 , Math.PI*2, false);
            ctx.strokeStyle = "yellow";
            ctx.stroke();
            ctx.closePath();

            ctx.beginPath();
            ctx.fillStyle = "yellow";
            ctx.font = "10px century";
            ctx.fillText("G", coin[l].x-4, coin[l].y+204);
            ctx.closePath();
        
        
            coin[l].x--;
            
            
            
            
            if( coin[l].x == 350 ){  //ドカン左端位置が200進んだら（200 = canvas幅:500 - ドカン左端pipe[i].x 300）
                coin.push({
                    x : cvs.width,
                    y : Math.floor(Math.random()*50)-50
                });
            }
            
            
                if(bX<=coin[l].x && bX+bird.width >= coin[l].x && bY-10<=coin[l].y+200 && coin[l].y+200<=bY+bird.height+10){
                    score++;
                    coin[l] = "invisible";
                }
    }

          
        for(var m=0 ; m < ground.length; m++){
            //console.log('pipe.length:' + pipe.length);
           
            ctx.drawImage(fg,ground[m].x,cvs.height - fg.height);
                ground[m].x--;
              
                if( bX>=pipe[n].x+375 && bX+bird.width<=pipe[n].x+450 && bY+bird.height>cvs.height-fg.height ||　bY+bird.height>cvs.height-fg.height+1 && bY+bird.height<=cvs.height+100){
            bY += 5;
           
            if(bY>cvs.height){
        
                setTimeout(reload,1000);
                ctx.font = "50px serif";
                ctx.fillStyle ="red";
                ctx.fillText("GAME OVER",75,cvs.height/2);
               
            }
        }else if(bY+bird.height<=cvs.height-fg.height){
            bY += 0.3;
        }

        if(spacePressed && bY+bird.height>=cvs.height-fg.height && bY+bird.height<=cvs.height-fg.height+1 && (bX>=pipe[n].x&&bX<pipe[n].x+375||bX+bird.width>pipe[n].x+450&&bX+bird.width<=pipe[n].x+600||bX+bird.width<=ground[m].x+600)) {
            bY -= 50 ;
        }
            
            if( ground[m].x == 350 ){  //ドカン左端位置が200進んだら（200 = canvas幅:500 - ドカン左端pipe[i].x 300）
                ground.push({
                    x : cvs.width,
                    y : Math.floor(Math.random()*fg.height)-fg.height
                });
            }
         
        }
        
        if(score == 100){
            setTimeout(reload,100);
            ctx.fillStyle ="red";                  
            ctx.font = "50px serif";
            ctx.fillText("CLEAR",175,cvs.height/2);
        }    
      
    }
        
        ctx.fillStyle = "#000"; //カラー
        ctx.font = "16px"; //大きさ
        ctx.fillText("点数 : " + score + ' point',10,cvs.height-20); //表示内容、位置
        requestAnimationFrame(draw);

        
       
    }

    
    draw();
</script>
</body>
</html>